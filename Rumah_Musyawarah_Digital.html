<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rumah Musyawarah Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); transition: opacity 0.3s ease; }
        .modal { transition: opacity 0.3s ease, transform 0.3s ease; }
        .sidebar-icon { transition: all 0.2s ease-in-out; }
        .sidebar-icon:hover { transform: scale(1.1); }
        .poll-bar-fill { transition: width 0.5s ease-in-out; }
        .calendar-day.has-event { background-color: #fef9c3; border-color: #facc15; cursor: pointer; transition: background-color 0.2s; }
        .calendar-day.has-event:hover { background-color: #fde68a; }
        .toast { animation: slideIn 0.5s forwards, fadeOut 0.5s 2.5s forwards; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .aspirasi-card-clickable { cursor: pointer; }
        .control-icon { transition: color 0.2s ease-in-out; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .btn-loading .btn-text { visibility: hidden; }
        .btn-loading::after { content: ''; position: absolute; width: 16px; height: 16px; top: 0; left: 0; right: 0; bottom: 0; margin: auto; border: 2px solid transparent; border-top-color: #ffffff; border-radius: 50%; animation: button-loading-spinner 1s ease infinite; }
        @keyframes button-loading-spinner { from { transform: rotate(0turn); } to { transform: rotate(1turn); } }
        #notification-badge { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .mention-suggestion { cursor: pointer; }
        .mention-suggestion:hover { background-color: #eef2ff; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex h-screen overflow-hidden">

    <!-- App Content (initially hidden) -->
    <div id="app-container" class="flex h-screen w-full hidden">
        <!-- Sidebar Navigation -->
        <aside class="w-20 bg-white shadow-lg flex flex-col items-center py-6 space-y-8 overflow-y-auto">
            <div class="text-indigo-600"><i class="fa-solid fa-people-roof fa-2x"></i></div>
            <nav class="flex flex-col items-center space-y-6">
                <a href="#" id="nav-aspirasi" class="sidebar-icon text-indigo-600 p-3 rounded-lg bg-indigo-100" title="Papan Aspirasi"><i class="fa-solid fa-comments fa-fw fa-lg"></i></a>
                <a href="#" id="nav-bursa" class="sidebar-icon text-gray-500 hover:text-indigo-600" title="Bursa Warga"><i class="fa-solid fa-store fa-fw fa-lg"></i></a>
                <a href="#" id="nav-polling" class="sidebar-icon text-gray-500 hover:text-indigo-600" title="Polling Warga"><i class="fa-solid fa-check-to-slot fa-fw fa-lg"></i></a>
                <a href="#" id="nav-kalender" class="sidebar-icon text-gray-500 hover:text-indigo-600" title="Kalender Gotong Royong"><i class="fa-solid fa-calendar-days fa-fw fa-lg"></i></a>
                <a href="#" id="nav-dana" class="sidebar-icon text-gray-500 hover:text-indigo-600" title="Dana Warga"><i class="fa-solid fa-wallet fa-fw fa-lg"></i></a>
                <a href="#" id="nav-dokumen" class="sidebar-icon text-gray-500 hover:text-indigo-600" title="Dokumen Penting"><i class="fa-solid fa-file-alt fa-fw fa-lg"></i></a>
                <a href="#" id="nav-info" class="sidebar-icon text-gray-500 hover:text-indigo-600" title="Info Warga"><i class="fa-solid fa-circle-info fa-fw fa-lg"></i></a>
                <a href="#" id="nav-admin" class="sidebar-icon text-gray-500 hover:text-indigo-600 hidden" title="Panel Admin"><i class="fa-solid fa-user-shield fa-fw fa-lg"></i></a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-6 lg:p-8 overflow-y-auto">
            <div id="broadcast-banner-container"></div>
            <header class="flex flex-col sm:flex-row justify-between sm:items-center gap-4 mb-6">
                <div>
                    <h1 id="page-title" class="text-3xl font-bold text-gray-900"></h1>
                    <p id="page-subtitle" class="text-gray-500"></p>
                </div>
                <div class="flex items-center gap-4">
                     <div class="relative">
                        <button id="notification-btn" class="text-gray-500 hover:text-indigo-600 p-2 rounded-full relative">
                            <i class="fa-solid fa-bell fa-lg"></i>
                            <span id="notification-badge" class="hidden absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></span>
                        </button>
                        <div id="notification-panel" class="hidden absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-xl z-20 overflow-hidden">
                            <div class="p-4 font-semibold border-b">Notifikasi</div>
                            <div id="notification-list" class="max-h-96 overflow-y-auto"></div>
                        </div>
                     </div>
                     <a href="#" id="user-profile-link" class="text-right flex items-center gap-3 cursor-pointer">
                        <div>
                            <p class="font-semibold text-gray-800" id="username-display"></p>
                            <button id="logout-btn" class="text-sm text-indigo-600 hover:underline">Keluar</button>
                        </div>
                        <div id="user-avatar-display" class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold"></div>
                     </a>
                     <button id="main-action-button" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg shadow-md hover:bg-indigo-700 transition duration-200 flex items-center gap-2 relative">
                        <i class="fa-solid fa-plus"></i>
                        <span id="main-action-button-text" class="btn-text"></span>
                    </button>
                </div>
            </header>
            
            <div id="page-specific-controls" class="mb-6"></div>
            <div id="content-area"></div>
        </main>
    </div>

    <!-- Welcome Modal -->
    <div id="welcome-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-sm p-8 text-center">
            <i class="fa-solid fa-people-roof fa-3x text-indigo-600 mb-4"></i>
            <h2 class="text-2xl font-bold mb-2">Selamat Datang!</h2>
            <p class="text-gray-600 mb-6">Silakan masukkan nama Anda untuk bergabung di ruang musyawarah digital.</p>
            <form id="welcome-form">
                <input type="text" id="username-input" class="w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Nama Anda..." required>
                <button type="submit" class="w-full mt-4 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Masuk</button>
            </form>
        </div>
    </div>

    <!-- Modals & Toasts Container -->
    <div id="modals-container"></div>
    <div id="toast-container" class="fixed top-5 right-5 z-50 space-y-3 w-80"></div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- GLOBAL STATE & CONSTANTS ---
        let appState;
        const AVATAR_COLORS = ['#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e', '#14b8a6', '#06b6d4', '#3b82f6', '#8b5cf6', '#d946ef', '#ec4899'];
        const initialData = {
            aspirasi: [ { id: 1, author: 'Bapak Agus', title: 'Lampu Jalan di Depan Blok C Mati', content: 'Selamat pagi, Pak RT. Saya mau melaporkan lampu jalan di depan rumah saya (Blok C3) sudah mati sekitar 3 hari. Mohon bantuannya agar segera diperbaiki karena cukup gelap dan rawan. Terima kasih.', category: 'Fasilitas', status: 'Sudah Ditindaklanjuti', upvotes: ['Ibu Rina', 'Admin RT'], comments: [{id: 101, author: 'Admin RT', text: 'Terima kasih laporannya Pak Agus, akan segera kami teruskan ke pihak terkait.'}], timestamp: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString() }, { id: 2, author: 'Ibu Rina', title: 'Usulan Kerja Bakti Akhir Pekan', content: 'Bagaimana kalau akhir pekan ini kita adakan kerja bakti membersihkan selokan? Sepertinya sudah mulai banyak sampah dan daun kering yang menyumbat.', category: 'Kebersihan', status: 'Sedang Didiskusikan', upvotes: ['Bapak Agus', 'Warga Lain'], comments: [{id:102, author:'Bapak Agus', text: 'Saya setuju sekali bu!'}], timestamp: new Date(Date.now() - 10 * 60 * 1000).toISOString() } ],
            polling: [ { id: 1, question: 'Setuju dengan usulan kerja bakti hari Minggu ini?', options: [{ text: 'Setuju', votes: 12 }, { text: 'Tidak Setuju', votes: 3 }], votedBy: {}, deadline: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000).toISOString() }, { id: 2, question: 'Kegiatan apa yang paling cocok untuk 17-an tahun ini?', options: [{ text: 'Lomba Anak-anak', votes: 8 }, { text: 'Panggung Gembira', votes: 15 }, { text: 'Tirakatan & Doa Bersama', votes: 7 }], votedBy: {}, deadline: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString() } ],
            kalenderEvents: [ { id: 1, date: `${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}-10`, title: 'Pembayaran Iuran Warga', rsvps: {} }, { id: 2, date: `${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}-25`, title: 'Rapat RT Bulanan', rsvps: {} } ],
            danaWarga: { balance: 1250000, transactions: [ {id: 1, date: '2025-10-01', description: 'Saldo Awal Bulan', amount: 1500000, type: 'income'}, {id: 2, date: '2025-10-05', description: 'Pembelian Lampu Jalan Blok C', amount: -250000, type: 'expense'} ] },
            dokumen: [ { id: 1, title: 'Notulen Rapat September 2025', description: 'Hasil rapat bulanan bersama warga.', category: 'Notulen Rapat', timestamp: new Date().toISOString() }, { id: 2, title: 'Laporan Keuangan Q3 2025', description: 'Rincian pemasukan dan pengeluaran kas RT.', category: 'Laporan Keuangan', timestamp: new Date().toISOString() } ],
            bursa: [ {id: 1, author: 'Ibu Rina', title: 'Jual Kue Nastar Lebaran', category: 'Jual & Beli', content: 'Menerima pesanan kue nastar wisman untuk lebaran. Harga Rp 75.000 per toples. Hubungi saya untuk pemesanan.', timestamp: new Date().toISOString()} ],
        };

        // --- SECTION: HELPER FUNCTIONS ---
        function timeAgo(date) { const seconds = Math.floor((new Date() - new Date(date)) / 1000); if (seconds < 60) return "Beberapa saat yang lalu"; const minutes = Math.floor(seconds / 60); if (minutes < 60) return `${minutes} menit yang lalu`; const hours = Math.floor(minutes / 60); if (hours < 24) return `${hours} jam yang lalu`; const days = Math.floor(hours / 24); if (days < 30) return `${days} hari yang lalu`; const months = Math.floor(days / 30); if (months < 12) return `${months} bulan yang lalu`; const years = Math.floor(months / 12); return `${years} tahun yang lalu`; }
        function getAvatarColor(username) { if (!appState.users[username]) { const hash = [...username].reduce((acc, char) => char.charCodeAt(0) + ((acc << 5) - acc), 0); appState.users[username] = { avatarColor: AVATAR_COLORS[Math.abs(hash) % AVATAR_COLORS.length], joinDate: new Date().toISOString() }; } return appState.users[username].avatarColor; }
        function Avatar(username, size = 'sm') { const sizeClasses = { sm: 'w-8 h-8 text-sm', md: 'w-10 h-10', lg: 'w-20 h-20 text-3xl'}[size]; return `<div class="${sizeClasses} rounded-full flex items-center justify-center text-white font-bold flex-shrink-0" style="background-color: ${getAvatarColor(username)};">${username ? username.charAt(0).toUpperCase() : '?'}</div>`; }
        
        // --- SECTION: STATE & STORAGE ---
        function saveState() { localStorage.setItem('rumahMusyawarahState', JSON.stringify(appState)); }
        function loadState() {
            const defaultState = { username: null, users: {}, currentPage: 'aspirasi', notifications:[], broadcast: { message: null, dismissedBy: [] }, aspirasi: { items: [], filters: { searchTerm: '', category: 'Semua', sortBy: 'terbaru' } }, polling: [], kalender: { year: new Date().getFullYear(), month: new Date().getMonth(), events: [] }, danaWarga: { balance: 0, transactions: [] }, dokumen: [], bursa:[], info: { title: "Informasi Penting Warga RT 05/RW 02", content: "## Jadwal Siskamling Pekan Ini\nBerikut adalah jadwal siskamling yang berlaku untuk pekan ini. Mohon warga yang bertugas dapat hadir tepat waktu.\n- Senin: Blok A1-A5\n- Selasa: Blok A6-A10\n- Rabu: Blok B1-B5\n\n## Pembayaran Iuran Warga\nDiingatkan kembali kepada seluruh warga untuk segera melunasi iuran kebersihan dan keamanan bulan ini." } };
            appState = defaultState;
            const savedState = localStorage.getItem('rumahMusyawarahState');
            if (savedState) {
                const parsedState = JSON.parse(savedState);
                Object.assign(appState, parsedState);
            } else {
                appState.aspirasi.items = initialData.aspirasi;
                appState.polling = initialData.polling;
                appState.kalender.events = initialData.kalenderEvents;
                appState.danaWarga = initialData.danaWarga;
                appState.dokumen = initialData.dokumen;
                appState.bursa = initialData.bursa;
            }
            appState.username = localStorage.getItem('rumahMusyawarahUsername');
        }
        
        // --- SECTION: UI COMPONENTS & TEMPLATES ---
        function EmptyState(icon, message, cta) { return `<div class="col-span-full text-center py-16 px-6 text-gray-500 fade-in"><i class="fa-solid ${icon} fa-4x text-gray-300 mb-6"></i><p class="mb-4">${message}</p>${cta || ''}</div>`; }
        function AspirasiControls() { return `<div class="flex flex-col md:flex-row gap-3"><div class="relative flex-grow"><i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i><input type="text" id="search-aspirasi" placeholder="Cari aspirasi..." class="w-full pl-10 pr-4 py-2 border rounded-lg" value="${appState.aspirasi.filters.searchTerm}"></div><select id="filter-category" class="border rounded-lg px-4 py-2">${['Semua', 'Keamanan', 'Kebersihan', 'Fasilitas', 'Sosial'].map(c => `<option value="${c}" ${appState.aspirasi.filters.category === c ? 'selected' : ''}>${c}</option>`).join('')}</select><select id="sort-by" class="border rounded-lg px-4 py-2">${[{v:'terbaru',t:'Terbaru'},{v:'terlama',t:'Terlama'},{v:'populer',t:'Paling Populer'}].map(s => `<option value="${s.v}" ${appState.aspirasi.filters.sortBy === s.v ? 'selected' : ''}>${s.t}</option>`).join('')}</select></div>`; }
        function AspirasiPage() {
            let items = [...appState.aspirasi.items];
            const { searchTerm, category, sortBy } = appState.aspirasi.filters;
            if (searchTerm) items = items.filter(i => i.title.toLowerCase().includes(searchTerm.toLowerCase()));
            if (category !== 'Semua') items = items.filter(i => i.category === category);
            
            const trendingItems = [...appState.aspirasi.items].sort((a,b) => (b.upvotes.length + b.comments.length) - (a.upvotes.length + a.comments.length)).slice(0,3);
            const upcomingEvents = appState.kalender.events.filter(e => new Date(e.date) >= new Date()).sort((a,b) => new Date(a.date) - new Date(b.date)).slice(0, 2);

            if (sortBy === 'terlama') items.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            else if (sortBy === 'populer') items.sort((a,b) => (b.upvotes.length + b.comments.length) - (a.upvotes.length + a.comments.length));
            else items.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            return `<div class="grid grid-cols-1 lg:grid-cols-4 gap-8"><div class="lg:col-span-3"><h2 class="text-2xl font-bold mb-4">Aspirasi Terhangat</h2><div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 mb-8">${trendingItems.length > 0 ? trendingItems.map(item => AspirasiCard(item, true)).join('') : '<p class="text-gray-500 col-span-3">Belum ada aspirasi yang cukup populer.</p>'}</div><h2 class="text-2xl font-bold mb-4">Semua Aspirasi</h2><div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6" id="aspirasi-list">${items.length > 0 ? items.map(AspirasiCard).join('') : EmptyState('fa-comments', 'Tidak ada aspirasi yang cocok dengan filter Anda.', `<button id="reset-filters-btn" class="text-indigo-600 hover:underline">Tampilkan Semua Aspirasi</button>`)}</div></div><div class="lg:col-span-1"><h2 class="text-2xl font-bold mb-4">Agenda Mendatang</h2><div class="space-y-4">${upcomingEvents.length > 0 ? upcomingEvents.map(e => `<div class="bg-white p-4 rounded-lg shadow-sm"><p class="font-bold">${e.title}</p><p class="text-sm text-gray-500">${new Date(e.date).toLocaleDateString('id-ID', {weekday: 'long', day:'numeric', month:'long'})}</p></div>`).join('') : '<p class="text-sm text-gray-500">Tidak ada agenda terdekat.</p>'}</div></div></div>`;
        }
        function AspirasiCard(item, isTrending = false) {
            const statusColors = {'Baru Diajukan': 'bg-blue-100 text-blue-800', 'Sedang Didiskusikan': 'bg-yellow-100 text-yellow-800', 'Sudah Ditindaklanjuti': 'bg-green-100 text-green-800'};
            const status = item.status || 'Baru Diajukan';
            const statusClass = statusColors[status] || 'bg-gray-100 text-gray-800';
            return `<div class="bg-white p-6 rounded-lg shadow-sm hover:shadow-lg transition-shadow duration-200 flex flex-col relative fade-in"><div class="absolute top-4 right-4 text-gray-400 flex gap-3">${(appState.username === item.author || appState.username === 'Admin RT') && !isTrending ? `<i class="fa-solid fa-pencil control-icon p-2 hover:text-indigo-600 cursor-pointer edit-aspirasi-btn" data-id="${item.id}" title="Edit"></i><i class="fa-solid fa-trash-can control-icon p-2 hover:text-red-600 cursor-pointer delete-aspirasi-btn" data-id="${item.id}" title="Hapus"></i>` : ''}</div><div class="flex-grow aspirasi-card-clickable" data-id="${item.id}"><div class="flex items-center gap-2 mb-2"><span class="text-xs font-semibold px-2 py-1 rounded-full bg-indigo-100 text-indigo-700">${item.category}</span><span class="text-xs font-semibold px-2 py-1 rounded-full ${statusClass}">${status}</span></div><h3 class="font-bold text-lg text-gray-800">${item.title}</h3><p class="text-sm text-gray-500 mb-2">Oleh: ${item.author} &bull; ${timeAgo(item.timestamp)}</p><p class="text-gray-600 line-clamp-3">${item.content}</p></div><div class="mt-4 pt-4 border-t border-gray-200 flex justify-between items-center"><button data-id="${item.id}" class="upvote-btn flex items-center gap-2 text-sm font-medium ${item.upvotes.includes(appState.username) ? 'text-indigo-600' : 'text-gray-500 hover:text-indigo-600'}"><i class="fa-solid fa-thumbs-up"></i><span>${item.upvotes.length}</span></button><a href="#" class="aspirasi-card-clickable text-sm font-medium text-indigo-600" data-id="${item.id}"><i class="fa-solid fa-comment"></i> ${item.comments.length}</a></div></div>`; }
        function PollingPage() { return `<div class="space-y-6" id="polling-list">${appState.polling.length > 0 ? appState.polling.map(PollingCard).join('') : EmptyState('fa-check-to-slot', 'Belum ada polling yang aktif.')}</div>`; }
        function PollingCard(item) {
            const totalVotes = item.options.reduce((sum, opt) => sum + opt.votes, 0); const isVoted = item.votedBy.hasOwnProperty(appState.username); const votedOptionIndex = item.votedBy[appState.username]; const isExpired = new Date(item.deadline) < new Date(); const deadlineText = isExpired ? `Ditutup pada ${new Date(item.deadline).toLocaleDateString('id-ID')}` : `Berakhir pada ${new Date(item.deadline).toLocaleDateString('id-ID')}`;
            return `<div class="bg-white p-6 rounded-lg shadow-sm ${isExpired ? 'opacity-70' : ''}"><h3 class="font-bold text-xl mb-1">${item.question}</h3><p class="text-sm text-gray-500 mb-4">${deadlineText}</p><div class="space-y-3">${item.options.map((opt, index) => { const percentage = totalVotes > 0 ? ((opt.votes / totalVotes) * 100).toFixed(0) : 0; const isSelected = isVoted && index === votedOptionIndex; return `<button ${isVoted || isExpired ? 'disabled' : ''} data-poll-id="${item.id}" data-option-index="${index}" class="poll-vote-btn w-full text-left p-3 border rounded-md transition-colors ${isVoted || isExpired ? 'cursor-not-allowed bg-gray-50' : 'hover:bg-indigo-50'} ${isSelected ? 'border-indigo-500 ring-2 ring-indigo-300' : ''}"><div class="flex justify-between items-center"><span>${opt.text} ${isSelected ? '<i class="fa-solid fa-check text-indigo-600"></i>' : ''}</span>${isVoted || isExpired ? `<span class="font-semibold">${opt.votes} suara (${percentage}%)</span>` : ''}</div>${isVoted || isExpired ? `<div class="mt-2 w-full bg-gray-200 rounded-full h-2.5"><div class="poll-bar-fill bg-indigo-600 h-2.5 rounded-full" style="width: ${percentage}%"></div></div>` : ''}</button>`}).join('')}</div><div class="flex justify-between items-center"><p class="text-sm text-gray-500 mt-4">Total Suara: ${totalVotes}</p>${isVoted && !isExpired ? `<button data-poll-id="${item.id}" class="retract-vote-btn mt-4 text-sm text-indigo-600 hover:underline">Batalkan suara</button>` : ''}</div></div>`;
        }
        function KalenderPage() { const { year, month } = appState.kalender; const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"]; let firstDay = new Date(year, month, 1).getDay(); firstDay = (firstDay === 0) ? 6 : firstDay - 1; const daysInMonth = new Date(year, month + 1, 0).getDate(); let calendarDays = Array.from({length: firstDay}, () => `<div></div>`).join(''); for (let day = 1; day <= daysInMonth; day++) { const fullDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`; const event = appState.kalender.events.find(e => e.date === fullDate); calendarDays += `<div class="calendar-day border border-gray-200 p-2 rounded-md ${event ? 'has-event' : ''}" ${event ? `data-date="${fullDate}"` : ''}><div class="font-semibold">${day}</div>${event ? `<div class="text-xs mt-1 bg-yellow-400 text-yellow-900 rounded-full px-1 py-0.5 truncate">${event.title}</div>` : ''}</div>`; } return `<div class="bg-white p-6 rounded-lg shadow-sm"><div class="flex justify-between items-center mb-4"><button id="prev-month" class="p-2 rounded-full hover:bg-gray-100"><i class="fa-solid fa-chevron-left"></i></button><h2 class="text-xl font-bold">${monthNames[month]} ${year}</h2><button id="next-month" class="p-2 rounded-full hover:bg-gray-100"><i class="fa-solid fa-chevron-right"></i></button></div><div class="grid grid-cols-7 gap-2 text-center font-semibold text-gray-500 text-sm mb-2"><div>Sen</div><div>Sel</div><div>Rab</div><div>Kam</div><div>Jum</div><div>Sab</div><div>Min</div></div><div class="grid grid-cols-7 gap-2">${calendarDays}</div></div>`; }
        function DanaWargaPage() { const { balance, transactions } = appState.danaWarga; const formatCurrency = (amount) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(amount); const adminControls = appState.username === 'Admin RT' ? `<div class="flex gap-4"><button id="add-income-btn" class="bg-green-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-green-600">Tambah Pemasukan</button><button id="add-expense-btn" class="bg-red-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-red-600">Tambah Pengeluaran</button></div>` : ''; return `<div class="bg-white p-6 rounded-lg shadow-sm"><div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4"><div class="mb-6 md:mb-0"><h3 class="text-lg font-medium text-gray-500">Saldo Kas RT Saat Ini</h3><p class="text-4xl font-bold text-indigo-600">${formatCurrency(balance)}</p></div>${adminControls}</div><h3 class="text-xl font-bold mb-4">Riwayat Transaksi</h3><div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="border-b"><th class="p-2">Tanggal</th><th class="p-2">Deskripsi</th><th class="p-2 text-right">Jumlah</th></tr></thead><tbody>${transactions.sort((a,b) => new Date(b.date) - new Date(a.date)).map(tx => `<tr class="border-b"><td class="p-2">${new Date(tx.date).toLocaleDateString('id-ID')}</td><td class="p-2">${tx.description}</td><td class="p-2 text-right ${tx.type === 'income' ? 'text-green-600' : 'text-red-600'}">${formatCurrency(tx.amount)}</td></tr>`).join('')}</tbody></table></div></div>`; }
        function InfoPage() { const adminControls = appState.username === 'Admin RT' ? `<div class="absolute top-4 right-4"><button id="edit-info-btn" class="bg-indigo-600 text-white text-sm font-semibold px-3 py-1 rounded-lg hover:bg-indigo-700">Edit Halaman</button></div>` : ''; const parsedContent = appState.info.content.replace(/## (.*)/g, '<h3>$1</h3>').replace(/- (.*)/g, '<li>$1</li>').replace(/<\/li>\n<li>/g, '</li><li>').replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>'); return `<div class="bg-white p-8 rounded-lg shadow-sm prose max-w-none relative">${adminControls}<h2 class="font-bold text-2xl mb-4">${appState.info.title}</h2>${parsedContent}</div>`; }
        function DokumenPage() { const adminControls = appState.username === 'Admin RT' ? `<button id="upload-doc-btn" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700">Unggah Dokumen</button>` : ''; return `<div class="bg-white p-6 rounded-lg shadow-sm"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">Dokumen Penting</h2>${adminControls}</div><div class="space-y-4">${appState.dokumen.length > 0 ? appState.dokumen.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp)).map(doc => `<div class="border p-4 rounded-lg flex justify-between items-center"><div class="flex items-center gap-4"><i class="fa-solid fa-file-lines fa-2x text-indigo-500"></i><div><p class="font-bold">${doc.title}</p><p class="text-sm text-gray-500">${doc.description} - <span class="text-xs px-2 py-1 bg-gray-200 rounded-full">${doc.category}</span></p></div></div><div class="flex gap-4 items-center">${appState.username==='Admin RT' ? `<button data-id="${doc.id}" class="delete-doc-btn text-xs text-red-500 hover:underline">Hapus</button>`:''}<button class="download-doc-btn text-indigo-600 hover:underline">Unduh</button></div></div>`).join('') : EmptyState('fa-file-excel', 'Belum ada dokumen yang diunggah.')}</div></div>`;}
        function ProfilPage(username) {
            const user = appState.users[username] || {};
            const isMyProfile = username === appState.username;
            const userAspirasi = appState.aspirasi.items.filter(a => a.author === username); const userCommentsCount = appState.aspirasi.items.reduce((acc, a) => acc + a.comments.filter(c => c.author === username).length, 0); const userUpvotesCount = appState.aspirasi.items.reduce((acc, a) => acc + (a.upvotes.includes(username) ? 1 : 0), 0); 
            return `<div class="flex items-center gap-6 bg-white p-8 rounded-lg shadow-sm mb-8"><div class="flex-shrink-0">${Avatar(username, 'lg')}</div><div><h2 class="text-3xl font-bold">${username}</h2><p class="text-gray-500">Bergabung sejak ${user.joinDate ? new Date(user.joinDate).toLocaleDateString('id-ID', {year:'numeric', month:'long', day:'numeric'}) : '-'}</p></div></div><div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"><div class="bg-white p-6 rounded-lg shadow-sm text-center"><p class="text-4xl font-bold text-indigo-600">${userAspirasi.length}</p><p class="text-gray-500">Aspirasi Dibuat</p></div><div class="bg-white p-6 rounded-lg shadow-sm text-center"><p class="text-4xl font-bold text-indigo-600">${userCommentsCount}</p><p class="text-gray-500">Komentar Diberikan</p></div><div class="bg-white p-6 rounded-lg shadow-sm text-center"><p class="text-4xl font-bold text-indigo-600">${userUpvotesCount}</p><p class="text-gray-500">Dukungan Diberikan</p></div></div><h2 class="text-2xl font-bold mb-4">${isMyProfile ? 'Aspirasi Saya' : `Aspirasi oleh ${username}`}</h2><div>${userAspirasi.length > 0 ? userAspirasi.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).map(item => AspirasiCard(item)).join('') : EmptyState('fa-comment-slash', `${isMyProfile ? 'Anda' : username} belum membuat aspirasi apapun.`)}</div>`; 
        }
        function AdminPage() { const totalUsers = Object.keys(appState.users).length; const totalAspirasi = appState.aspirasi.items.length; const totalPolling = appState.polling.length; return `<div class="space-y-8"><div><h2 class="text-2xl font-bold mb-4">Dasbor Admin</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="bg-white p-6 rounded-lg shadow-sm text-center"><p class="text-4xl font-bold text-indigo-600">${totalUsers}</p><p class="text-gray-500">Total Warga Terdaftar</p></div><div class="bg-white p-6 rounded-lg shadow-sm text-center"><p class="text-4xl font-bold text-indigo-600">${totalAspirasi}</p><p class="text-gray-500">Total Aspirasi</p></div><div class="bg-white p-6 rounded-lg shadow-sm text-center"><p class="text-4xl font-bold text-indigo-600">${totalPolling}</p><p class="text-gray-500">Total Polling</p></div></div></div><div><h2 class="text-2xl font-bold mb-4">Siaran Pengumuman</h2><form id="broadcast-form" class="bg-white p-6 rounded-lg shadow-sm flex gap-4 items-center"><input type="text" name="broadcast-message" placeholder="Tulis pengumuman di sini..." class="w-full border rounded-lg p-2" value="${appState.broadcast.message || ''}"><button type="submit" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg">Kirim</button>${appState.broadcast.message ? `<button type="button" id="clear-broadcast" class="bg-red-500 text-white font-semibold px-4 py-2 rounded-lg">Hapus</button>` : ''}</form></div><div><h2 class="text-2xl font-bold mb-4">Manajemen Warga</h2><div class="bg-white p-6 rounded-lg shadow-sm"><table class="w-full text-left"><thead><tr class="border-b"><th>Nama Warga</th><th>Kontribusi</th></tr></thead><tbody>${Object.keys(appState.users).map(user => `<tr><td class="p-2 flex items-center gap-2">${Avatar(user, 'sm')} ${user}</td><td class="p-2 text-sm text-gray-500">${appState.aspirasi.items.filter(a=>a.author === user).length} aspirasi</td></tr>`).join('')}</tbody></table></div></div></div>`; }
        function BursaPage() { const adminControls = (item) => appState.username === 'Admin RT' || appState.username === item.author ? `<button data-id="${item.id}" class="delete-bursa-btn text-xs text-red-500 hover:underline">Hapus</button>` : ''; return `<div class="space-y-6">${appState.bursa.length > 0 ? appState.bursa.map(item => `<div class="bg-white p-6 rounded-lg shadow-sm"><div class="flex justify-between items-start"><div><span class="text-xs font-semibold px-2 py-1 rounded-full bg-gray-200 text-gray-800">${item.category}</span><h3 class="font-bold text-xl my-2">${item.title}</h3></div><div class="text-right text-sm text-gray-500">${timeAgo(item.timestamp)}<br>${adminControls(item)}</div></div><p class="text-gray-600 mt-2">${item.content}</p><div class="mt-4 pt-4 border-t flex items-center gap-2"><div class="flex-shrink-0">${Avatar(item.author, 'sm')}</div><p class="text-sm font-semibold">${item.author}</p></div></div>`).join('') : EmptyState('fa-store', 'Bursa warga masih kosong.')}</div>`; }
        
        // --- SECTION: MODALS & NOTIFICATIONS ---
        function showToast(message, type = 'success') { const icon = type === 'success' ? 'fa-check-circle' : 'fa-times-circle'; const color = type === 'success' ? 'bg-green-500' : 'bg-red-500'; const toast = document.createElement('div'); toast.className = `toast ${color} text-white p-4 rounded-lg shadow-lg flex items-center gap-3`; toast.innerHTML = `<i class="fa-solid ${icon}"></i> <p>${message}</p>`; document.getElementById('toast-container').appendChild(toast); setTimeout(() => toast.remove(), 3000); }
        function createModal(modalId, content) { const modalHTML = `<div id="${modalId}" class="modal-backdrop fixed inset-0 z-40 flex items-center justify-center p-4 opacity-0 pointer-events-none">${content}</div>`; document.getElementById('modals-container').innerHTML = modalHTML; const modal = document.getElementById(modalId); setTimeout(() => { modal.classList.remove('opacity-0', 'pointer-events-none'); modal.querySelector('.modal').classList.remove('-translate-y-10'); }, 10); return modal; }
        function closeModal(modal) { if (!modal) return; modal.classList.add('opacity-0'); modal.querySelector('.modal').classList.add('-translate-y-10'); setTimeout(() => modal.remove(), 300); }
        function showConfirmationModal(title, message, onConfirm) { const modalId = `confirm-modal-${Date.now()}`; const content = `<div class="modal bg-white rounded-lg shadow-2xl w-full max-w-sm transform -translate-y-10 p-6 text-center"><i class="fa-solid fa-triangle-exclamation fa-2x text-yellow-500 mb-3"></i><h3 class="text-xl font-bold my-2">${title}</h3><p class="text-gray-600 mb-6">${message}</p><div class="flex justify-center gap-3"><button class="cancel-modal-btn px-6 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Batal</button><button class="confirm-btn px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Ya, Lanjutkan</button></div></div>`; const modal = createModal(modalId, content); modal.querySelector('.cancel-modal-btn').onclick = () => closeModal(modal); modal.onclick = (e) => { if (e.target === modal) closeModal(modal); }; modal.querySelector('.confirm-btn').onclick = () => { onConfirm(); closeModal(modal); }; }
        function showFormModal(title, formContent, submitHandler, initialData = {}) { const modalId = `form-modal-${Date.now()}`; const content = `<div class="modal bg-white rounded-lg shadow-2xl w-full max-w-md p-6 transform -translate-y-10"><h3 class="text-xl font-bold mb-4">${title}</h3><form id="modal-form">${formContent}<div class="flex justify-end gap-3 mt-6"><button type="button" class="cancel-modal-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Batal</button><button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 relative"><span class="btn-text">Simpan</span></button></div></form></div>`; const modal = createModal(modalId, content); Object.keys(initialData).forEach(key => { if(modal.querySelector(`[name=${key}]`)) modal.querySelector(`[name=${key}]`).value = initialData[key]; }); modal.querySelector('.cancel-modal-btn').onclick = () => closeModal(modal); modal.onclick = (e) => { if (e.target === modal) closeModal(modal); }; modal.querySelector('#modal-form').onsubmit = async (e) => { e.preventDefault(); const submitBtn = e.target.querySelector('button[type="submit"]'); submitBtn.classList.add('btn-loading'); submitBtn.disabled = true; await new Promise(res => setTimeout(res, 500)); submitHandler(e.target); submitBtn.classList.remove('btn-loading'); submitBtn.disabled = false; closeModal(modal); }; }
        
        // --- SECTION: FEATURE-SPECIFIC ACTIONS & MODALS ---
        function showAspirasiDetailModal(aspirasiId) {
            const item = appState.aspirasi.items.find(a => a.id === aspirasiId); if (!item) return;
            const content = `<div class="modal bg-white rounded-lg shadow-2xl w-full max-w-2xl transform -translate-y-10"><div class="p-6 border-b flex justify-between items-start"><div><span class="text-xs font-semibold px-2 py-1 rounded-full bg-indigo-100 text-indigo-700 mb-2 inline-block">${item.category}</span><h3 class="text-2xl font-bold">${item.title}</h3><p class="text-sm text-gray-500">Oleh: ${item.author} &bull; ${new Date(item.timestamp).toLocaleString('id-ID', { dateStyle: 'full', timeStyle: 'short' })}</p></div><div class="flex items-center gap-4">${(appState.username === item.author || appState.username === 'Admin RT') ? `<select data-id="${item.id}" class="status-change-select text-xs border-gray-300 rounded-md">${['Baru Diajukan', 'Sedang Didiskusikan', 'Sudah Ditindaklanjuti'].map(s=>`<option value="${s}" ${item.status===s ? 'selected' : ''}>${s}</option>`).join('')}</select>`: `<p class="text-xs font-semibold px-2 py-1 rounded-full bg-gray-100 text-gray-800">${item.status}</p>`}</div></div><div class="p-6 max-h-[60vh] overflow-y-auto"><p class="text-gray-700 whitespace-pre-wrap mb-6">${item.content}</p><h4 class="font-semibold text-lg mb-3">Komentar (${item.comments.length})</h4><div class="space-y-4 mb-4" id="comment-list"></div><div class="flex gap-3 mt-4 relative"><div class="flex-shrink-0">${Avatar(appState.username, 'sm')}</div><div class="flex-grow"><input type="text" placeholder="Tulis komentar... (ketik @ untuk menyebut warga)" class="comment-input w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"><button class="add-comment-btn hidden">Submit</button><div id="mention-suggestions" class="hidden absolute bottom-full left-0 mb-1 w-full bg-white border rounded-lg shadow-lg max-h-40 overflow-y-auto z-10"></div></div></div></div><div class="p-4 bg-gray-50 flex justify-end rounded-b-lg"><button class="cancel-modal-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Tutup</button></div></div>`;
            const modal = createModal(`aspirasi-detail-${item.id}`, content);
            function renderComments() { modal.querySelector('#comment-list').innerHTML = item.comments.map(c => `<div class="flex gap-3 group">${Avatar(c.author, 'sm')}<div class="flex-grow bg-gray-100 p-3 rounded-lg text-sm"><div class="flex justify-between items-center"><strong class="font-semibold">${c.author}</strong><div class="hidden group-hover:flex items-center gap-2 text-gray-400">${(appState.username === c.author || appState.username === 'Admin RT') ? `<i class="fa-solid fa-pencil control-icon text-xs hover:text-indigo-600 cursor-pointer edit-comment-btn" data-comment-id="${c.id}"></i><i class="fa-solid fa-trash-can control-icon text-xs hover:text-red-600 cursor-pointer delete-comment-btn" data-comment-id="${c.id}"></i>` : ''}</div></div><p class="comment-text">${c.text.replace(/@(\w+)/g, '<strong class="text-indigo-600">@$1</strong>')}</p><div class="edit-comment-form hidden mt-2"><input type="text" class="w-full border rounded-md p-1" value="${c.text}"><div class="flex gap-2 mt-1"><button class="save-edit-comment-btn text-xs font-semibold text-indigo-600">Simpan</button><button class="cancel-edit-comment-btn text-xs text-gray-500">Batal</button></div></div></div></div>`).join('') || '<p class="text-gray-500 text-sm">Belum ada komentar.</p>'; addModalEventListeners(); }
            function handleComment() { const input = modal.querySelector('.comment-input'); if(input.value.trim()){ const newComment = { id: Date.now(), author: appState.username, text: input.value.trim() }; item.comments.push(newComment); if(item.author !== appState.username) createNotification(`**${appState.username}** mengomentari aspirasi Anda: *${item.title}*`, `aspirasi/${item.id}`, item.author); const mentions = input.value.match(/@(\w+)/g) || []; mentions.forEach(mention => { const username = mention.substring(1); if(appState.users[username] && username !== appState.username) createNotification(`**${appState.username}** menyebut Anda dalam komentar di: *${item.title}*`, `aspirasi/${item.id}`, username); }); input.value = ''; renderComments(); } }
            function handleMention(input) {
                const mentionBox = modal.querySelector('#mention-suggestions');
                const lastAt = input.value.lastIndexOf('@');
                if (lastAt > -1 && (lastAt === 0 || input.value[lastAt - 1] === ' ')) {
                    const query = input.value.substring(lastAt + 1).toLowerCase();
                    const suggestions = Object.keys(appState.users).filter(u => u.toLowerCase().startsWith(query) && u !== appState.username);
                    if (suggestions.length > 0) {
                        mentionBox.innerHTML = suggestions.map(s => `<div class="p-2 mention-suggestion" data-username="${s}">${s}</div>`).join('');
                        mentionBox.classList.remove('hidden');
                    } else { mentionBox.classList.add('hidden'); }
                } else { mentionBox.classList.add('hidden'); }
            }
            function addModalEventListeners() { /* ... includes mention click handler ... */ modal.querySelectorAll('.delete-comment-btn').forEach(btn => btn.onclick = (e) => { const commentId = parseInt(e.currentTarget.dataset.commentId); showConfirmationModal('Hapus Komentar?', 'Anda yakin ingin menghapus komentar ini?', () => { item.comments = item.comments.filter(c => c.id !== commentId); showToast('Komentar dihapus.'); renderComments(); }); }); modal.querySelectorAll('.edit-comment-btn').forEach(btn => btn.onclick = (e) => { const el = e.currentTarget.closest('.group'); el.querySelector('.comment-text').classList.add('hidden'); el.querySelector('.edit-comment-form').classList.remove('hidden'); }); modal.querySelectorAll('.cancel-edit-comment-btn').forEach(btn => btn.onclick = (e) => { const el = e.currentTarget.closest('.group'); el.querySelector('.comment-text').classList.remove('hidden'); el.querySelector('.edit-comment-form').classList.add('hidden'); }); modal.querySelectorAll('.save-edit-comment-btn').forEach(btn => btn.onclick = (e) => { const el = e.currentTarget.closest('.group'); const commentId = parseInt(el.querySelector('.edit-comment-btn').dataset.commentId); const newText = el.querySelector('input').value.trim(); if(newText) { item.comments.find(c => c.id === commentId).text = newText; showToast('Komentar diperbarui.'); renderComments(); } }); }
            const commentInput = modal.querySelector('.comment-input');
            commentInput.oninput = () => handleMention(commentInput);
            commentInput.onkeypress = (e) => { if(e.key === 'Enter') handleComment(); };
            modal.querySelector('.add-comment-btn').onclick = handleComment;
            modal.querySelector('#mention-suggestions').onclick = (e) => {
                const username = e.target.dataset.username;
                if (username) {
                    const lastAt = commentInput.value.lastIndexOf('@');
                    commentInput.value = commentInput.value.substring(0, lastAt) + `@${username} `;
                    modal.querySelector('#mention-suggestions').classList.add('hidden');
                    commentInput.focus();
                }
            };
            modal.onclick = (e) => { if (e.target === modal) { closeModal(modal); render(); } }; modal.querySelector('.cancel-modal-btn').onclick = () => { closeModal(modal); render(); };
            const statusSelect = modal.querySelector('.status-change-select');
            if (statusSelect) statusSelect.onchange = (e) => { item.status = e.target.value; showToast(`Status aspirasi diubah menjadi "${item.status}"`); render(); };
            renderComments();
        }
        function showKalenderEventModal(date) { const event = appState.kalender.events.find(e => e.date === date); if (!event) return; const rsvpStatus = event.rsvps[appState.username]; const attendees = Object.keys(event.rsvps).filter(u => event.rsvps[u] === 'hadir'); const content = `<div class="modal bg-white rounded-lg shadow-2xl w-full max-w-md transform -translate-y-10 p-6"><i class="fa-solid fa-calendar-check fa-2x text-indigo-500 mb-3"></i><p class="text-sm text-gray-500">${new Date(date + 'T00:00:00').toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</p><h3 class="text-xl font-bold my-2">${event.title}</h3><div class="my-4"><p class="font-semibold mb-2">Konfirmasi Kehadiran:</p><div class="flex justify-center gap-2">${['hadir', 'mungkin', 'tidak'].map(s => `<button data-event-id="${event.id}" data-status="${s}" class="rsvp-btn px-3 py-1 text-sm rounded-full ${rsvpStatus === s ? 'bg-indigo-600 text-white' : 'bg-gray-200'}">${s.charAt(0).toUpperCase() + s.slice(1)}</button>`).join('')}</div></div><div class="my-4"><p class="font-semibold mb-2">Akan Hadir (${attendees.length}):</p><div class="flex flex-wrap gap-2 justify-center">${attendees.length > 0 ? attendees.map(u => `<span class="text-xs bg-gray-200 px-2 py-1 rounded-full">${u}</span>`).join('') : '<p class="text-sm text-gray-500">Belum ada yang konfirmasi.</p>'}</div></div><button class="cancel-modal-btn mt-4 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 w-full">Tutup</button></div>`; const modal = createModal(`event-detail-${date}`, content); modal.onclick = (e) => { if (e.target === modal || e.target.closest('.cancel-modal-btn')) closeModal(modal); const rsvpBtn = e.target.closest('.rsvp-btn'); if(rsvpBtn) { event.rsvps[appState.username] = rsvpBtn.dataset.status; closeModal(modal); showKalenderEventModal(date); } };}
        function deleteAspirasi(aspirasiId, afterAction = () => {}) { showConfirmationModal('Hapus Aspirasi?', 'Anda yakin ingin menghapus aspirasi ini?', () => { appState.aspirasi.items = appState.aspirasi.items.filter(a => a.id !== aspirasiId); showToast('Aspirasi berhasil dihapus.'); afterAction(); render(); }); }
        function editAspirasi(aspirasiId, afterAction = () => {}) { const item = appState.aspirasi.items.find(a => a.id === aspirasiId); if (!item) return; showFormModal('Edit Aspirasi', `<div class="space-y-4"><div><label class="block text-sm font-medium text-gray-700">Judul Aspirasi</label><input type="text" name="title" required class="mt-1 block w-full border rounded-md py-2 px-3"></div><div><label class="block text-sm font-medium text-gray-700">Kategori</label><select name="category" class="mt-1 block w-full border rounded-md py-2 px-3 bg-white"><option>Keamanan</option><option>Kebersihan</option><option>Fasilitas</option><option>Sosial</option></select></div><div><label class="block text-sm font-medium text-gray-700">Isi Aspirasi</label><textarea name="content" rows="4" required class="mt-1 block w-full border rounded-md py-2 px-3"></textarea></div></div>`, (form) => { item.title = form.title.value; item.content = form.content.value; item.category = form.category.value; showToast('Aspirasi berhasil diperbarui!'); afterAction(); render(); }, { title: item.title, content: item.content, category: item.category }); }
        
        // --- SECTION: NOTIFICATION LOGIC ---
        function createNotification(text, link, targetUser) { const notif = { id: Date.now(), text, link, read: false, user: targetUser, timestamp: new Date().toISOString() }; appState.notifications.unshift(notif); }
        function renderNotifications() {
            const unreadCount = appState.notifications.filter(n => !n.read && n.user === appState.username).length;
            document.getElementById('notification-badge').style.display = unreadCount > 0 ? 'block' : 'none';
            const list = document.getElementById('notification-list');
            const userNotifications = appState.notifications.filter(n => n.user === appState.username);
            list.innerHTML = userNotifications.length > 0 ? userNotifications.map(n => `<a href="#" data-link="${n.link}" data-id="${n.id}" class="notification-item block p-4 hover:bg-gray-100 ${!n.read ? 'bg-indigo-50' : ''}"><p class="text-sm">${n.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>')}</p><p class="text-xs text-gray-500 mt-1">${timeAgo(n.timestamp)}</p></a>`).join('') : '<p class="text-sm text-gray-500 p-4 text-center">Tidak ada notifikasi baru.</p>';
        }

        // --- SECTION: PAGE DEFINITIONS ---
        const pages = {
            admin: { title: 'Panel Admin', subtitle: 'Manajemen dan statistik lingkungan', controls: null, content: AdminPage, showButton: false },
            profil: { title: 'Profil Warga', subtitle: 'Jejak kontribusi warga di lingkungan', controls: null, content: (username) => ProfilPage(username || appState.username), showButton: false },
            aspirasi: { title: 'Papan Aspirasi', subtitle: 'Ruang diskusi dan aspirasi untuk warga', controls: AspirasiControls, content: AspirasiPage, actionText: 'Buat Aspirasi', action: () => showFormModal('Buat Aspirasi Baru', `<div class="space-y-4"><div><label class="block text-sm font-medium text-gray-700">Judul</label><input type="text" name="title" required class="mt-1 block w-full border rounded-md py-2 px-3" placeholder="cth: Usulan Kerja Bakti"></div><div><label class="block text-sm font-medium text-gray-700">Kategori</label><select name="category" class="mt-1 block w-full border rounded-md py-2 px-3 bg-white"><option>Keamanan</option><option>Kebersihan</option><option>Fasilitas</option><option>Sosial</option></select></div><div><label class="block text-sm font-medium text-gray-700">Isi Aspirasi</label><textarea name="content" rows="4" required class="mt-1 block w-full border rounded-md py-2 px-3" placeholder="Jelaskan aspirasi Anda..."></textarea></div></div>`, (form) => { appState.aspirasi.items.unshift({ id: Date.now(), author: appState.username, title: form.title.value, content: form.content.value, category: form.category.value, status: 'Baru Diajukan', upvotes: [], comments: [], timestamp: new Date().toISOString() }); showToast('Aspirasi baru berhasil dibuat!'); render(); })},
            bursa: { title: 'Bursa Warga', subtitle: 'Papan jual/beli dan permintaan bantuan', controls: null, content: BursaPage, actionText: 'Buat Postingan', action: () => showFormModal('Buat Postingan Bursa', `<div class="space-y-4">...</div>`, form => { /* ... */ }) },
            polling: { title: 'Polling Warga', subtitle: 'Ikut serta dalam pengambilan keputusan bersama', controls: null, content: PollingPage, actionText: 'Buat Polling', action: () => showFormModal('Buat Polling Baru', `<div class="space-y-4"><div><label>Pertanyaan</label><input name="question" required class="w-full border p-2 rounded"></div><div><label>Opsi Jawaban</label><input name="option1" required class="w-full border p-2 rounded"><input name="option2" required class="w-full border p-2 rounded mt-1"><input name="option3" class="w-full border p-2 rounded mt-1"></div><div><label>Batas Waktu</label><input name="deadline" type="date" required class="w-full border p-2 rounded"></div></div>`, (form) => { const options = [form.option1, form.option2, form.option3].filter(opt => opt.value.trim() !== '').map(opt => ({ text: opt.value, votes: 0 })); if (options.length < 2) { showToast('Polling harus memiliki minimal 2 opsi.', 'error'); return; } appState.polling.unshift({ id: Date.now(), question: form.question.value, options, votedBy: {}, deadline: new Date(form.deadline.value).toISOString() }); showToast('Polling baru berhasil dibuat!'); render(); })},
            kalender: { title: 'Kalender Gotong Royong', subtitle: 'Jadwal kegiatan bersama warga', controls: null, content: KalenderPage, actionText: 'Tambah Kegiatan', action: () => showFormModal('Tambah Kegiatan Baru', `<div class="space-y-4"><div><label>Nama Kegiatan</label><input name="title" required class="w-full border p-2 rounded"></div><div><label>Tanggal</label><input name="date" type="date" required class="w-full border p-2 rounded"></div></div>`, (form) => { appState.kalender.events.push({ id: Date.now(), title: form.title.value, date: form.date.value, rsvps: {} }); showToast('Kegiatan baru ditambahkan!'); render(); })},
            dana: { title: 'Dana Warga', subtitle: 'Transparansi keuangan untuk kegiatan bersama', controls: null, content: DanaWargaPage, showButton: false },
            dokumen: { title: 'Dokumen Penting', subtitle: 'Arsip digital untuk semua warga', controls: null, content: DokumenPage, showButton: false },
            info: { title: 'Info Warga', subtitle: 'Informasi penting dari pengurus RT', controls: null, content: InfoPage, showButton: false }
        };
        pages.bursa.action = () => showFormModal('Buat Postingan Bursa', `<div class="space-y-4"><div><label>Judul Postingan</label><input name="title" required class="w-full border p-2 rounded"></div><div><label>Kategori</label><select name="category" class="w-full bg-white border p-2 rounded"><option>Jual & Beli</option><option>Cari Bantuan</option><option>Tawarkan Jasa</option></select></div><div><label>Konten</label><textarea name="content" rows="4" required class="w-full border p-2 rounded"></textarea></div></div>`, form => { appState.bursa.unshift({id:Date.now(), author: appState.username, title: form.title.value, category: form.category.value, content: form.content.value, timestamp: new Date().toISOString()}); render(); });

        // --- SECTION: CORE APP LOGIC ---
        function render() {
            const page = pages[appState.currentPage];
            document.getElementById('page-title').textContent = page.title;
            document.getElementById('page-subtitle').textContent = page.subtitle;
            document.getElementById('content-area').innerHTML = typeof page.content === 'function' ? page.content() : page.content;
            document.getElementById('page-specific-controls').innerHTML = page.controls ? page.controls() : '';
            const mainActionButton = document.getElementById('main-action-button');
            if (page.showButton !== false) {
                mainActionButton.style.display = 'flex';
                mainActionButton.querySelector('span').textContent = page.actionText;
                const newBtn = mainActionButton.cloneNode(true); mainActionButton.parentNode.replaceChild(newBtn, mainActionButton); newBtn.addEventListener('click', page.action);
            } else { mainActionButton.style.display = 'none'; }
            document.getElementById('nav-admin').style.display = appState.username === 'Admin RT' ? 'block' : 'none';
            updateActiveNav();
            addEventListeners();
            renderBroadcast();
            renderNotifications();
            saveState();
        }
        function renderBroadcast() {
            const container = document.getElementById('broadcast-banner-container');
            const broadcast = appState.broadcast;
            if (broadcast.message && !broadcast.dismissedBy.includes(appState.username)) {
                container.innerHTML = `<div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6 flex justify-between items-center role="alert"><p><strong class="font-bold">Pengumuman:</strong> ${broadcast.message}</p><button id="dismiss-broadcast" class="text-xl font-bold">&times;</button></div>`;
                document.getElementById('dismiss-broadcast').onclick = () => { broadcast.dismissedBy.push(appState.username); render(); };
            } else { container.innerHTML = ''; }
        }
        function navigate(page, data = null) {
            appState.currentPage = page;
            if (page === 'profil' && typeof data === 'string') {
                appState.activeProfile = data;
                document.getElementById('content-area').innerHTML = pages.profil.content(data);
            } else {
                appState.activeProfile = null;
                render();
            }
            if (data && (page === 'aspirasi' || page === 'bursa')) {
                setTimeout(() => {
                    const el = document.querySelector(`[data-id='${data}']`);
                    if (el) {
                        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        el.classList.add('animate-pulse');
                        setTimeout(() => el.classList.remove('animate-pulse'), 2000);
                    }
                }, 100);
            }
        }
        function updateActiveNav() {
            document.querySelectorAll('aside nav a').forEach(a => { a.classList.remove('text-indigo-600', 'bg-indigo-100'); a.classList.add('text-gray-500'); });
            const activeLink = document.getElementById(`nav-${appState.currentPage}`);
            if(activeLink) { activeLink.classList.add('text-indigo-600', 'bg-indigo-100'); activeLink.classList.remove('text-gray-500'); }
        }
        function addEventListeners() {
            document.getElementById('content-area').onclick = (e) => {
                const target = e.target;
                const handlers = {
                    '.aspirasi-card-clickable': (el) => showAspirasiDetailModal(parseInt(el.dataset.id)),
                    '.poll-vote-btn': (el) => { const pollId = parseInt(el.dataset.pollId), optionIndex = parseInt(el.dataset.optionIndex); const poll = appState.polling.find(p => p.id === pollId); if (poll && !poll.votedBy[appState.username]) { poll.options[optionIndex].votes++; poll.votedBy[appState.username] = optionIndex; showToast('Terima kasih, suara Anda telah direkam!'); render(); } },
                    '.retract-vote-btn': (el) => { const pollId = parseInt(el.dataset.pollId); showConfirmationModal('Batalkan Suara?', 'Anda yakin ingin membatalkan suara Anda?', () => { const poll = appState.polling.find(p => p.id === pollId); if (poll && poll.votedBy.hasOwnProperty(appState.username)) { const votedIdx = poll.votedBy[appState.username]; poll.options[votedIdx].votes--; delete poll.votedBy[appState.username]; showToast('Suara Anda dibatalkan.'); render(); } }); },
                    '.upvote-btn': (el) => { const aspirasiId = parseInt(el.dataset.id); const aspirasi = appState.aspirasi.items.find(a => a.id === aspirasiId); const upvotedIndex = aspirasi.upvotes.indexOf(appState.username); if (upvotedIndex > -1) { aspirasi.upvotes.splice(upvotedIndex, 1); } else { aspirasi.upvotes.push(appState.username); if(aspirasi.author !== appState.username) createNotification(`**${appState.username}** mendukung aspirasi Anda: *${aspirasi.title}*`, `aspirasi/${aspirasi.id}`, aspirasi.author); } render(); },
                    '.delete-aspirasi-btn': (el) => { e.stopPropagation(); deleteAspirasi(parseInt(el.dataset.id)); },
                    '.edit-aspirasi-btn': (el) => { e.stopPropagation(); editAspirasi(parseInt(el.dataset.id)); },
                    '.calendar-day.has-event': (el) => showKalenderEventModal(el.dataset.date),
                    '#reset-filters-btn': () => { appState.aspirasi.filters = { searchTerm: '', category: 'Semua', sortBy: 'terbaru' }; render(); },
                    '#add-income-btn': () => showFormModal('Tambah Pemasukan', `<div class="space-y-4"><div><label>Deskripsi</label><input name="desc" type="text" required class="w-full border rounded p-2"></div><div><label>Jumlah</label><input name="amount" type="number" required class="w-full border rounded p-2"></div></div>`, form => { const amount = parseFloat(form.amount.value); appState.danaWarga.transactions.push({id:Date.now(), date: new Date().toISOString(), description: form.desc.value, amount, type: 'income'}); appState.danaWarga.balance += amount; render(); }),
                    '#add-expense-btn': () => showFormModal('Tambah Pengeluaran', `<div class="space-y-4"><div><label>Deskripsi</label><input name="desc" type="text" required class="w-full border rounded p-2"></div><div><label>Jumlah</label><input name="amount" type="number" required class="w-full border rounded p-2"></div></div>`, form => { const amount = parseFloat(form.amount.value); appState.danaWarga.transactions.push({id:Date.now(), date: new Date().toISOString(), description: form.desc.value, amount: -amount, type: 'expense'}); appState.danaWarga.balance -= amount; render(); }),
                    '#edit-info-btn': () => showFormModal('Edit Informasi Warga', `<div class="space-y-4"><div><label>Konten (gunakan Markdown)</label><textarea name="content" rows="10" class="w-full border rounded p-2 font-mono text-sm"></textarea></div></div>`, form => { appState.info.content = form.content.value; render(); }, { content: appState.info.content }),
                    '#upload-doc-btn': () => showFormModal('Unggah Dokumen Baru', `<div class="space-y-4"><div><label>Judul Dokumen</label><input name="title" type="text" required class="w-full border rounded p-2"></div><div><label>Kategori</label><select name="category" class="w-full border rounded p-2 bg-white"><option>Notulen Rapat</option><option>Laporan Keuangan</option><option>Surat Edaran</option><option>Lainnya</option></select></div><div><label>Deskripsi Singkat</label><input name="description" type="text" class="w-full border rounded p-2"></div></div>`, form => { appState.dokumen.push({id: Date.now(), title: form.title.value, description: form.description.value, category: form.category.value, timestamp: new Date().toISOString()}); render(); }),
                    '.download-doc-btn': () => showToast('Simulasi unduh dokumen berhasil!', 'success'),
                    '.delete-doc-btn': (el) => showConfirmationModal('Hapus Dokumen?', 'Anda yakin?', () => { appState.dokumen = appState.dokumen.filter(d => d.id != el.dataset.id); render(); }),
                    '.delete-bursa-btn': (el) => showConfirmationModal('Hapus Postingan?', 'Anda yakin ingin menghapus postingan ini?', () => { appState.bursa = appState.bursa.filter(b => b.id != el.dataset.id); render(); }),
                };
                for (const selector in handlers) {
                    const el = target.closest(selector);
                    if (el) { handlers[selector](el); return; }
                }
            };
            const broadcastForm = document.getElementById('broadcast-form');
            if(broadcastForm) broadcastForm.onsubmit = (e) => { e.preventDefault(); appState.broadcast.message = e.target['broadcast-message'].value; appState.broadcast.dismissedBy = []; showToast('Siaran pengumuman dikirim!'); render(); };
            const clearBroadcastBtn = document.getElementById('clear-broadcast');
            if(clearBroadcastBtn) clearBroadcastBtn.onclick = () => { appState.broadcast.message = null; appState.broadcast.dismissedBy = []; showToast('Siaran pengumuman dihapus.'); render(); };

            const controls = document.getElementById('page-specific-controls');
            controls.oninput = (e) => { if (e.target.id === 'search-aspirasi') { appState.aspirasi.filters.searchTerm = e.target.value; render(); } };
            controls.onchange = (e) => { if (e.target.id === 'filter-category') appState.aspirasi.filters.category = e.target.value; if (e.target.id === 'sort-by') appState.aspirasi.filters.sortBy = e.target.value; render(); };
            document.getElementById('prev-month')?.addEventListener('click', () => { appState.kalender.month = (appState.kalender.month === 0) ? 11 : appState.kalender.month - 1; if (appState.kalender.month === 11) appState.kalender.year--; render(); });
            document.getElementById('next-month')?.addEventListener('click', () => { appState.kalender.month = (appState.kalender.month === 11) ? 0 : appState.kalender.month + 1; if (appState.kalender.month === 0) appState.kalender.year++; render(); });
        }
        
        // --- SECTION: INITIALIZATION ---
        function initializeApp() {
            loadState();
            const appContainer = document.getElementById('app-container'), welcomeModal = document.getElementById('welcome-modal'), userProfileLink = document.getElementById('user-profile-link');
            if (appState.username) {
                welcomeModal.style.display = 'none';
                appContainer.classList.remove('hidden');
                document.getElementById('username-display').textContent = appState.username;
                document.getElementById('user-avatar-display').innerHTML = Avatar(appState.username, 'md');
                render();
            } else {
                welcomeModal.style.display = 'flex';
                appContainer.classList.add('hidden');
            }
            const welcomeForm = document.getElementById('welcome-form');
            if(welcomeForm) welcomeForm.onsubmit = (e) => { e.preventDefault(); const username = document.getElementById('username-input').value.trim(); if (username) { if(!appState.users[username]) getAvatarColor(username); appState.username = username; localStorage.setItem('rumahMusyawarahUsername', username); initializeApp(); } };
            
            const logoutBtn = document.getElementById('logout-btn');
            if(logoutBtn) logoutBtn.onclick = () => showConfirmationModal('Keluar Akun?', `Anda yakin ingin keluar sebagai ${appState.username}?`, () => { localStorage.removeItem('rumahMusyawarahUsername'); appState.username = null; saveState(); location.reload(); });
            
            // Navigation
            if(userProfileLink) userProfileLink.onclick = (e) => { e.preventDefault(); if(!e.target.closest('#logout-btn')) navigate('profil', appState.username); }
            const navAspirasi = document.getElementById('nav-aspirasi');
            if(navAspirasi) navAspirasi.onclick = (e) => { e.preventDefault(); navigate('aspirasi'); };
            const navBursa = document.getElementById('nav-bursa');
            if(navBursa) navBursa.onclick = (e) => { e.preventDefault(); navigate('bursa'); };
            const navPolling = document.getElementById('nav-polling');
            if(navPolling) navPolling.onclick = (e) => { e.preventDefault(); navigate('polling'); };
            const navKalender = document.getElementById('nav-kalender');
            if(navKalender) navKalender.onclick = (e) => { e.preventDefault(); navigate('kalender'); };
            const navDana = document.getElementById('nav-dana');
            if(navDana) navDana.onclick = (e) => { e.preventDefault(); navigate('dana'); };
            const navDokumen = document.getElementById('nav-dokumen');
            if(navDokumen) navDokumen.onclick = (e) => { e.preventDefault(); navigate('dokumen'); };
            const navInfo = document.getElementById('nav-info');
            if(navInfo) navInfo.onclick = (e) => { e.preventDefault(); navigate('info'); };
            const navAdmin = document.getElementById('nav-admin');
            if(navAdmin) navAdmin.onclick = (e) => { e.preventDefault(); navigate('admin'); };
            
            // Notifications
            const notifBtn = document.getElementById('notification-btn');
            const notifPanel = document.getElementById('notification-panel');
            if(notifBtn) notifBtn.onclick = () => { notifPanel.classList.toggle('hidden'); renderNotifications(); };
            document.addEventListener('click', (e) => { if (notifBtn && !notifBtn.contains(e.target) && notifPanel && !notifPanel.contains(e.target)) notifPanel.classList.add('hidden'); });
            if(notifPanel) notifPanel.onclick = (e) => { const item = e.target.closest('.notification-item'); if(item) { const notif = appState.notifications.find(n => n.id == item.dataset.id); if(notif) notif.read = true; const [page, id] = item.dataset.link.split('/'); navigate(page, id); notifPanel.classList.add('hidden'); }};
        }

        initializeApp();
    });
    </script>
</body>
</html>

